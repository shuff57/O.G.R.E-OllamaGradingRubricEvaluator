<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Ollama Grading Assistant</title>
  <link rel="icon" type="image/png" href="favicon.png">
  <link rel="stylesheet" href="lib/mathlive-static.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
  <style>
    body { font-family: sans-serif; padding: 10px; background: #f9f9f9; }
    .card { position: relative; background: white; padding: 10px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 15px; }
    h3 { margin-top: 0; font-size: 14px; color: #333; }
    label { font-size: 12px; font-weight: bold; color: #555; display: block; margin-bottom: 5px; }
    input, textarea, select { width: 100%; padding: 8px; box-sizing: border-box; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 4px; }
    
    /* Default (Grader) - Green Theme */
    button { width: 100%; background: #16a34a; color: white; border: none; padding: 10px; border-radius: 4px; cursor: pointer; font-weight: bold; margin-bottom: 5px; transition: background-color 0.3s; }
    button:hover { background: #15803d; }
    
    /* Solver Mode - Blue Theme */
    body.solver-mode button { background: #2563eb; }
    body.solver-mode button:hover { background: #1d4ed8; }

    button.secondary { background: #e5e7eb; color: #333; }
    button.secondary:hover { background: #d1d5db; }
    /* Ensure secondary buttons stay gray in solver mode */
    body.solver-mode button.secondary { background: #e5e7eb; color: #333; }
    body.solver-mode button.secondary:hover { background: #d1d5db; }

    .preview { max-width: 100%; height: auto; border: 1px solid #ccc; margin-top: 5px; display: none; }
    #status { font-size: 12px; color: #666; margin-top: 10px; }
    #response { white-space: pre-wrap; font-size: 13px; line-height: 1.4; }
    
    /* LaTeX Toolbar */
    .latex-toolbar {
      display: flex;
      flex-wrap: wrap;
      gap: 2px;
      margin-bottom: 5px;
      background: #eee;
      padding: 4px;
      border-radius: 4px;
    }
    .latex-btn {
      background: white;
      border: 1px solid #ccc;
      border-radius: 3px;
      cursor: pointer;
      font-size: 11px;
      padding: 2px 6px;
      min-width: 24px;
      color: #333;
    }
    .latex-btn:hover {
      background: #e0e0e0;
      border-color: #999;
    }

    /* Rich Editor */
    .rich-editor {
      width: 100%;
      min-height: 80px;
      padding: 8px;
      box-sizing: border-box;
      margin-bottom: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      background: white;
      font-family: sans-serif;
      font-size: 13px;
      overflow-y: auto;
      white-space: pre-wrap;
    }
    .rich-editor:focus {
      outline: 2px solid #16a34a;
      border-color: transparent;
    }
    body.solver-mode .rich-editor:focus {
      outline: 2px solid #2563eb;
    }
    /* Placeholder simulation */
    .rich-editor:empty:before {
      content: attr(placeholder);
      color: #aaa;
    }
    
    /* Math Field in Editor */
    .rich-editor math-field {
      display: inline-block;
      width: auto;
      min-width: 110px; /* Increased to ensure icons are visible */
      padding: 2px 4px;
      padding-right: 0px; /* Reserve space for the two icons on the right */
      box-sizing: border-box;
      margin: 0 2px;
      border: 1px solid transparent;
      background: rgba(0,0,0,0.03);
      border-radius: 3px;
      vertical-align: middle;
      font-size: 1.1em;
    }
    
    /* Target the internal parts of the math-field to ensure icons are visible */
    .rich-editor math-field::part(menu-toggle),
    .rich-editor math-field::part(virtual-keyboard-toggle) {
      color: #555;
      opacity: 0.8;
      padding: 2px;
      display: flex !important; /* Force display */
      visibility: visible !important;
    }
    
    .rich-editor math-field::part(menu-toggle):hover,
    .rich-editor math-field::part(virtual-keyboard-toggle):hover {
      opacity: 1;
      background-color: rgba(0,0,0,0.1);
      border-radius: 4px;
    }

    .rich-editor math-field:focus-within {
      background: white;
      border-color: #16a34a;
      box-shadow: 0 0 0 1px #16a34a;
    }
    body.solver-mode .rich-editor math-field:focus-within {
      border-color: #2563eb;
      box-shadow: 0 0 0 1px #2563eb;
    }

    /* MathLive Modal */
    .modal {
      display: none; 
      position: fixed; 
      z-index: 1000; 
      left: 0;
      top: 0;
      width: 100%; 
      height: 100%; 
      overflow: auto; 
      background-color: rgba(0,0,0,0.4); 
    }
    .modal-content {
      background-color: #fefefe;
      margin: 15% auto; 
      padding: 20px;
      border: 1px solid #888;
      width: 90%; 
      border-radius: 8px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
    .modal-actions {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
    }

    /* Live Preview */
    .math-preview {
      border: 1px solid #eee;
      background: #fff;
      padding: 10px;
      border-radius: 4px;
      min-height: 40px;
      margin-bottom: 10px;
      font-size: 13px;
      line-height: 1.5;
      color: #333;
      white-space: pre-wrap; /* Preserve newlines */
    }
    /* Make read-only math fields blend in */
    .math-preview math-field {
      border: none;
      background: transparent;
      padding: 0 2px;
      margin: 0;
      display: inline-block;
      font-size: 1.1em;
    }
    .math-preview math-field:focus {
      outline: none;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Toggle Switch */
    .toggle-checkbox {
      display: none;
    }
    .toggle-label {
      display: flex;
      align-items: center;
      background-color: #dcfce7;
      border-radius: 20px;
      padding: 2px;
      cursor: pointer;
      position: relative;
      width: 100%;
      height: 24px;
      user-select: none;
      box-sizing: border-box;
      transition: background-color 0.4s ease;
    }
    .toggle-slider {
      position: absolute;
      top: 2px;
      left: 2px;
      width: calc(50% - 4px);
      height: 20px;
      background-color: white;
      border-radius: 18px;
      transition: left 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
      box-shadow: 0 1px 3px rgba(0,0,0,0.2);
      z-index: 1;
    }
    .toggle-text {
      flex: 1;
      text-align: center;
      font-size: 11px;
      font-weight: bold;
      z-index: 2;
      color: #777;
      transition: color 0.3s;
    }
    .toggle-checkbox:checked + .toggle-label {
      background-color: #dbeafe;
    }
    .toggle-checkbox:checked + .toggle-label .toggle-slider {
      left: calc(50% + 2px);
      transform: none;
    }
    .toggle-checkbox:not(:checked) + .toggle-label .text-grader {
      color: #15803d;
    }
    .toggle-checkbox:checked + .toggle-label .text-solver {
      color: #2563eb;
    }

    /* Chat Bubbles */
    .chat-message {
      padding: 8px 12px;
      border-radius: 15px;
      max-width: 80%;
      margin-bottom: 8px;
      font-size: 13px;
      line-height: 1.4;
    }
    .user-message {
      align-self: flex-end;
      background: #e3f2fd; /* Light Blue */
      border-radius: 15px 15px 0 15px;
      margin-left: auto;
    }
    .assistant-message {
      align-self: flex-start;
      background: #fff;
      border: 1px solid #ddd;
      border-radius: 15px 15px 15px 0;
      margin-right: auto;
    }
    #solverChatHistory {
      display: flex;
      flex-direction: column;
      gap: 10px;
      max-height: 300px;
      overflow-y: auto;
      padding: 10px;
      border: 1px solid #eee;
      border-radius: 4px;
      background: #f9f9f9;
      margin-bottom: 10px;
    }

    /* Integrated Input Container */
    .integrated-input-container {
      display: flex;
      flex-direction: column;
      border: 1px solid #ddd;
      border-radius: 4px;
      background: white;
      margin-bottom: 10px;
      padding: 5px;
      min-height: 80px;
      transition: outline 0.1s;
    }
    .integrated-input-container:focus-within {
      outline: 2px solid #16a34a;
      border-color: transparent;
    }
    body.solver-mode .integrated-input-container:focus-within {
      outline: 2px solid #2563eb;
    }
    
    /* Override rich-editor styles when inside integrated container */
    .integrated-input-container .rich-editor {
      border: none;
      margin-bottom: 0;
      padding: 5px;
      min-height: 60px;
      flex-grow: 1;
    }
    .integrated-input-container .rich-editor:focus {
      outline: none;
    }

    /* Integrated Controls */
    .integrated-controls {
      display: flex;
      flex-direction: row;
      gap: 5px;
      margin-top: 5px;
      border-top: 1px solid #eee;
      padding-top: 5px;
      align-items: center;
    }
    .integrated-controls button, 
    .integrated-controls label.button {
      border: none !important;
      background: transparent !important;
      color: #888 !important;
      width: 28px !important;
      height: 28px !important;
      padding: 0 !important;
      display: flex !important;
      align-items: center !important;
      justify-content: center !important;
      cursor: pointer !important;
      border-radius: 4px !important;
      margin-bottom: 0 !important;
    }
    .integrated-controls button:hover, 
    .integrated-controls label.button:hover {
      background: #f0f0f0 !important;
      color: #333 !important;
    }
    /* Active/Primary buttons in controls (like Send) */
    .integrated-controls button.primary-action {
      color: #2563eb !important;
      margin-left: auto !important; /* Push to right */
    }
    .integrated-controls button.primary-action:hover {
      background: #eff6ff !important;
    }

    /* Chat Interface Wrapper */
    #chatInterfaceWrapper {
      transition: all 0.2s;
    }
    
    /* Solver Chat History Base Styles */
    .solver-chat-history {
      display: none; /* Toggled by JS */
      flex-direction: column;
      gap: 10px;
      max-height: 300px;
      overflow-y: auto;
      padding: 10px;
      border: 1px solid #eee;
      border-radius: 4px;
      background: #f9f9f9;
      margin-bottom: 10px;
    }

    /* Solver Mode Integration Styles */
    body.solver-mode #chatInterfaceWrapper {
      border: 1px solid #ddd;
      border-radius: 6px;
      background: white;
      overflow: hidden;
      box-shadow: 0 2px 5px rgba(0,0,0,0.05);
      display: flex;
      flex-direction: column;
    }
    
    body.solver-mode .solver-chat-history {
      border: none !important;
      border-radius: 0 !important;
      margin-bottom: 0 !important;
      border-bottom: 1px solid #eee !important;
      background: #f8fafc; /* Slightly different bg for chat area */
      flex-grow: 1;
    }
    
    body.solver-mode .integrated-input-container {
      border: none !important;
      border-radius: 0 !important;
      margin-bottom: 0 !important;
      background: white;
      box-shadow: none !important;
    }
    
    /* Focus ring around the whole wrapper in solver mode */
    body.solver-mode #chatInterfaceWrapper:focus-within {
      border-color: #2563eb;
      box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.2);
    }
    body.solver-mode .integrated-input-container:focus-within {
      outline: none !important;
    }
  </style>
</head>
<body>

  <div class="card">
    <img src="logo.png" style="position: absolute; top: 10px; right: 10px; width: 100px; height: 45px; object-fit: cover; object-position: top;" alt="Logo">
    <h3><i class="bi bi-gear-fill"></i> Config</h3>
    <label>Ollama URL</label>
    <input type="text" id="apiUrl" value="https://ollama.com/api" placeholder="http://localhost:11434">
    <label>API Key (Optional)</label>
    <!-- NOT SECURE: Only do this for personal local extensions -->
<input type="password" id="apiKey" placeholder="Enter API Key if required" >
    <label>AI Model</label>
    <select id="modelName">
      <option value="gpt-oss:20b-cloud">ChatGPT-20b</option>
      <option value="gpt-oss:120b-cloud">ChatGPT-120b</option>
      <option value="qwen3-vl:235b-instruct-cloud">Qwen3-Vision</option>
      <option value="ministral-3:3b-cloud">Ministral-3-3b</option>
      <option value="ministral-3:8b-cloud">Ministral-3-8b</option>
      <option value="ministral-3:14b-cloud">Ministral-3-14b</option>
      <option value="gemma3:4b-cloud">Gemma3-4b</option>
      <option value="gemma3:12b-cloud">Gemma3-12b</option>
      <option value="gemma3:27b-cloud">Gemma3-27b</option>
      <option value="deepseek-v3.1:671b-cloud">Deepseek-v3.1</option>
      <option value="deepseek-v3.2:cloud">Deepseek-v3.2</option>
      <option value="gemini-3-pro-preview:latest">Gemini-3-Pro-preview</option>
      <option value="kimi-k2:1t-cloud">Kimi-K2</option>
      <option value="kimi-k2-thinking:cloud">Kimi-K2-Thinking</option>
      <option value="cogito-2.1:671b-cloud">Cogito-2.1</option>
      <option value="qwen3-next:80b-cloud">Qwen3-Next</option>
      <option value="rnj-1:8b-cloud">Rnj-1</option>
      <option value="mistral-large-3:675b-cloud">Mistral-Large-3</option>
    </select>

    <div id="thinkingControls" style="margin-bottom: 10px; display: none;">
      <div id="gptThinking" style="display: none;">
        <label>Thinking Level</label>
        <select id="thinkLevel">
          <option value="low">Low</option>
          <option value="medium">Medium</option>
          <option value="high">High</option>
        </select>
      </div>
      <div id="otherThinking" style="display: none;">
        <label style="display:inline-flex; align-items: center; font-weight: normal;">
          <input type="checkbox" id="thinkingMode" style="width: auto; margin-right: 5px; margin-bottom: 0;"> Enable Thinking Mode
        </label>
      </div>
    </div>

    <div style="display: flex; gap: 5px;">
      <button id="testConnection" class="secondary" style="flex: 1;"><i class="bi bi-wifi"></i> Test Connection</button>
      <button id="saveConfig" class="secondary" style="flex: 1;"><i class="bi bi-floppy"></i> Save Config</button>
    </div>
    <div id="configStatus" style="margin-top: 0; font-size: 0.9em; text-align: center; display: none;"></div>

    <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #eee; display: flex;">
      <div class="mode-toggle-wrapper" style="width: 100%;">
        <input type="checkbox" id="modeSwitch" class="toggle-checkbox">
        <label for="modeSwitch" class="toggle-label">
          <div class="toggle-slider"></div>
          <span class="toggle-text text-grader">Grader</span>
          <span class="toggle-text text-solver">Solver</span>
        </label>
      </div>
    </div>
  </div>

  <div class="card" id="rubricCard">
    <h3 id="rubricTitle"><i class="bi bi-list-check"></i> 1. Define Role / Rubric</h3>
    <div style="margin-bottom: 10px; display: flex; gap: 10px;">
      <label style="display:inline-flex; align-items: center; font-weight: normal;">
        <input type="radio" name="rubricMode" value="text" checked style="width: auto; margin-right: 5px; margin-bottom: 0;"> Text
      </label>
      <label style="display:inline-flex; align-items: center; font-weight: normal;">
        <input type="radio" name="rubricMode" value="table" style="width: auto; margin-right: 5px; margin-bottom: 0;"> Table
      </label>
    </div>

    <div style="display: flex; gap: 5px; margin-bottom: 5px;">
      <button id="btnGetRubricText" class="secondary" style="margin-bottom: 0; font-size: 12px; flex: 1;"><i class="bi bi-text-paragraph"></i> Get Highlighted Text</button>
      <button id="btnImportRubric" class="secondary" style="margin-bottom: 0; font-size: 12px; flex: 1;"><i class="bi bi-stars"></i> Import Rubric from Highlighted Text (AI)</button>
    </div>
    
    <div style="display: flex; gap: 5px; margin-bottom: 10px;">
      <button id="btnRubricArea" class="secondary" style="margin-bottom: 0; font-size: 12px; flex: 1;"><i class="bi bi-crop"></i> Screenshot Area</button>
      <button id="btnImportRubricImage" class="secondary" style="margin-bottom: 0; font-size: 12px; flex: 1;"><i class="bi bi-file-image"></i> Import Rubric from Screenshot (AI)</button>
    </div>

    <div id="rubricStatus" style="display:none; margin-bottom: 10px; padding: 8px; background: #e0f2fe; border: 1px solid #bae6fd; border-radius: 4px; color: #0369a1; font-size: 12px; align-items: center; gap: 8px;">
      <div class="spinner" style="width: 12px; height: 12px; border: 2px solid #0369a1; border-top-color: transparent; border-radius: 50%; animation: spin 1s linear infinite;"></div>
      <span id="rubricStatusText">Processing...</span>
    </div>

    <div id="rubricTextContainer">
      <div id="rubricText" class="rich-editor" contenteditable="true" placeholder="Paste rubric text here or upload image..."></div>
    </div>

    <div id="rubricTableContainer" style="display:none;">
      <table id="rubricTable" style="width:100%; border-collapse: collapse; margin-bottom: 10px; font-size: 12px;">
        <thead>
          <tr style="background: #f1f1f1;">
            <th style="border: 1px solid #ddd; padding: 5px; text-align: left;">Criteria</th>
            <th style="border: 1px solid #ddd; padding: 5px; text-align: left;">Description</th>
            <th style="border: 1px solid #ddd; padding: 5px; text-align: left; width: 50px;">Pts</th>
            <th style="border: 1px solid #ddd; padding: 5px; width: 20px;"></th>
          </tr>
        </thead>
        <tbody>
          <!-- Rows will be added here -->
        </tbody>
      </table>
      <button id="btnAddRow" class="secondary" style="width: auto; padding: 5px 10px; font-size: 12px;">+ Add Row</button>
    </div>

    <input type="file" id="rubricUpload" accept="image/*" multiple>
    <div id="rubricImagesContainer" style="display: flex; flex-wrap: wrap; gap: 5px; margin-top: 5px;"></div>
  </div>

  <div class="card">
    <h3 id="studentWorkTitle"><i class="bi bi-person-workspace"></i> 2. Student Work</h3>
    
    <div style="display: flex; gap: 5px; margin-bottom: 5px;">
      <button id="btnGetStudentText" class="secondary" style="margin-bottom: 0; font-size: 12px; flex: 1;"><i class="bi bi-text-paragraph"></i> Get Highlighted Text</button>
      <button id="btnImportStudent" class="secondary" style="margin-bottom: 0; font-size: 12px; flex: 1;"><i class="bi bi-stars"></i> Import Student Work from Text (AI)</button>
    </div>
    
    <div style="display: flex; gap: 5px; margin-bottom: 10px;">
      <button id="btnStudentArea" class="secondary" style="margin-bottom: 0; font-size: 12px; flex: 1;"><i class="bi bi-crop"></i> Screenshot Area</button>
      <button id="btnImportStudentImage" class="secondary" style="margin-bottom: 0; font-size: 12px; flex: 1;"><i class="bi bi-file-image"></i> Import Student Work from Screenshot (AI)</button>
    </div>
    
    <div id="chatInterfaceWrapper">
      <div id="solverChatHistory" class="solver-chat-history"></div>

      <div class="integrated-input-container">
        <div id="studentText" class="rich-editor" contenteditable="true" placeholder="Student text will appear here..."></div>
        
        <div id="studentControls" class="integrated-controls">
          <!-- Math button will be inserted here by JS -->
          <label for="studentUpload" class="button" title="Upload Image">
              <i class="bi bi-image"></i>
          </label>
          <button id="btnSolverSend" class="primary-action" style="display: none;" title="Send"><i class="bi bi-send-fill"></i></button>
        </div>
      </div>
    </div>
    
    <input type="file" id="studentUpload" accept="image/*" multiple style="display: none;">
    <div id="studentImagesContainer" style="display: flex; flex-wrap: wrap; gap: 5px; margin-top: 5px;"></div>
  </div>

  <div class="card">
    <button id="btnGrade">Run Assessment</button>
    <div id="status"></div>
  </div>

  <div class="card">
    <h3><i class="bi bi-clipboard-check"></i> Result:</h3>
    <details id="thinkingContainer" style="display:none; background:#f0f0f0; padding:10px; border-radius:4px; margin-bottom:10px; font-size:12px; color:#555; border-left: 3px solid #999;">
      <summary style="cursor: pointer; font-weight: bold;">Show Thinking Process</summary>
      <div id="thinkingContent" style="white-space: pre-wrap; margin-top:5px;"></div>
    </details>
    <div id="response"></div>
    
    <!-- Chat Section -->
    <div id="chatSection" style="display:none; margin-top: 15px; border-top: 1px solid #eee; padding-top: 10px;">
      <h4 style="margin-top: 0; margin-bottom: 10px; font-size: 14px;"><i class="bi bi-chat-dots"></i> Follow-up Chat</h4>
      <div id="chatHistory" style="max-height: 300px; overflow-y: auto; margin-bottom: 10px; border: 1px solid #eee; padding: 10px; border-radius: 4px; background: #f9f9f9; display: flex; flex-direction: column; gap: 10px;"></div>
      <div style="display: flex; gap: 5px;">
        <textarea id="chatInput" placeholder="Ask a question about the grading..." style="min-height: 40px; margin-bottom: 0; resize: vertical; font-family: sans-serif;"></textarea>
        <button id="btnSendChat" class="secondary" style="width: auto; padding: 0 15px;"><i class="bi bi-send"></i></button>
      </div>
    </div>
  </div>

  <script src="lib/mathlive.min.js"></script>
  <script src="lib/marked.min.js"></script>
  <script src="prompts.js"></script>
  <script src="sidepanel.js"></script>
</body>
</html>