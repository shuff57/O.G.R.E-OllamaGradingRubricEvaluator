<!DOCTYPE html>
<html>
<head>
  <title>Ollama Grading Assistant</title>
  <link rel="icon" type="image/png" href="favicon.png">
  <link rel="stylesheet" href="lib/mathlive-static.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
  <style>
    body { font-family: sans-serif; padding: 10px; background: #f9f9f9; }
    .card { position: relative; background: white; padding: 10px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 15px; }
    h3 { margin-top: 0; font-size: 14px; color: #333; }
    label { font-size: 12px; font-weight: bold; color: #555; display: block; margin-bottom: 5px; }
    input, textarea, select { width: 100%; padding: 8px; box-sizing: border-box; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 4px; }
    button { width: 100%; background: #2563eb; color: white; border: none; padding: 10px; border-radius: 4px; cursor: pointer; font-weight: bold; margin-bottom: 5px; }
    button:hover { background: #1d4ed8; }
    button.secondary { background: #e5e7eb; color: #333; }
    button.secondary:hover { background: #d1d5db; }
    .preview { max-width: 100%; height: auto; border: 1px solid #ccc; margin-top: 5px; display: none; }
    #status { font-size: 12px; color: #666; margin-top: 10px; }
    #response { white-space: pre-wrap; font-size: 13px; line-height: 1.4; }
    
    /* LaTeX Toolbar */
    .latex-toolbar {
      display: flex;
      flex-wrap: wrap;
      gap: 2px;
      margin-bottom: 5px;
      background: #eee;
      padding: 4px;
      border-radius: 4px;
    }
    .latex-btn {
      background: white;
      border: 1px solid #ccc;
      border-radius: 3px;
      cursor: pointer;
      font-size: 11px;
      padding: 2px 6px;
      min-width: 24px;
      color: #333;
    }
    .latex-btn:hover {
      background: #e0e0e0;
      border-color: #999;
    }

    /* Rich Editor */
    .rich-editor {
      width: 100%;
      min-height: 80px;
      padding: 8px;
      box-sizing: border-box;
      margin-bottom: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      background: white;
      font-family: sans-serif;
      font-size: 13px;
      overflow-y: auto;
      white-space: pre-wrap;
    }
    .rich-editor:focus {
      outline: 2px solid #2563eb;
      border-color: transparent;
    }
    /* Placeholder simulation */
    .rich-editor:empty:before {
      content: attr(placeholder);
      color: #aaa;
    }
    
    /* Math Field in Editor */
    .rich-editor math-field {
      display: inline-block;
      width: auto;
      min-width: 110px; /* Increased to ensure icons are visible */
      padding: 2px 4px;
      padding-right: 0px; /* Reserve space for the two icons on the right */
      box-sizing: border-box;
      margin: 0 2px;
      border: 1px solid transparent;
      background: rgba(0,0,0,0.03);
      border-radius: 3px;
      vertical-align: middle;
      font-size: 1.1em;
    }
    
    /* Target the internal parts of the math-field to ensure icons are visible */
    .rich-editor math-field::part(menu-toggle),
    .rich-editor math-field::part(virtual-keyboard-toggle) {
      color: #555;
      opacity: 0.8;
      padding: 2px;
      display: flex !important; /* Force display */
      visibility: visible !important;
    }
    
    .rich-editor math-field::part(menu-toggle):hover,
    .rich-editor math-field::part(virtual-keyboard-toggle):hover {
      opacity: 1;
      background-color: rgba(0,0,0,0.1);
      border-radius: 4px;
    }

    .rich-editor math-field:focus-within {
      background: white;
      border-color: #2563eb;
      box-shadow: 0 0 0 1px #2563eb;
    }

    /* MathLive Modal */
    .modal {
      display: none; 
      position: fixed; 
      z-index: 1000; 
      left: 0;
      top: 0;
      width: 100%; 
      height: 100%; 
      overflow: auto; 
      background-color: rgba(0,0,0,0.4); 
    }
    .modal-content {
      background-color: #fefefe;
      margin: 15% auto; 
      padding: 20px;
      border: 1px solid #888;
      width: 90%; 
      border-radius: 8px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
    .modal-actions {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
    }

    /* Live Preview */
    .math-preview {
      border: 1px solid #eee;
      background: #fff;
      padding: 10px;
      border-radius: 4px;
      min-height: 40px;
      margin-bottom: 10px;
      font-size: 13px;
      line-height: 1.5;
      color: #333;
      white-space: pre-wrap; /* Preserve newlines */
    }
    /* Make read-only math fields blend in */
    .math-preview math-field {
      border: none;
      background: transparent;
      padding: 0 2px;
      margin: 0;
      display: inline-block;
      font-size: 1.1em;
    }
    .math-preview math-field:focus {
      outline: none;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>

  <div class="card">
    <img src="logo.png" style="position: absolute; top: 10px; right: 10px; width: 100px; height: 45px; object-fit: cover; object-position: top;" alt="Logo">
    <h3><i class="bi bi-gear-fill"></i> Config</h3>
    <label>Ollama URL</label>
    <input type="text" id="apiUrl" value="https://ollama.com/api" placeholder="http://localhost:11434">
    <label>API Key (Optional)</label>
    <!-- NOT SECURE: Only do this for personal local extensions -->
<input type="password" id="apiKey" placeholder="Enter API Key if required" >
    <label>Model Name (Must support vision for images)</label>
    <select id="modelName">
      <option value="gpt-oss:20b-cloud">ChatGPT-20b</option>
      <option value="gpt-oss:120b-cloud">ChatGPT-120b</option>
      <option value="qwen3-vl:235b-instruct-cloud">Qwen3-Vision</option>
      <option value="ministral-3:3b-cloud">Ministral-3-3b</option>
      <option value="ministral-3:8b-cloud">Ministral-3-8b</option>
      <option value="ministral-3:14b-cloud">Ministral-3-14b</option>
      <option value="gemma3:4b-cloud">Gemma3-4b</option>
      <option value="gemma3:12b-cloud">Gemma3-12b</option>
      <option value="gemma3:27b-cloud">Gemma3-27b</option>
      <option value="deepseek-v3.1:671b-cloud">Deepseek-v3.1</option>
      <option value="deepseek-v3.2:cloud">Deepseek-v3.2</option>
      <option value="gemini-3-pro-preview:latest">Gemini-3-Pro-preview</option>
      <option value="kimi-k2:1t-cloud">Kimi-K2</option>
      <option value="kimi-k2-thinking:cloud">Kimi-K2-Thinking</option>
      <option value="cogito-2.1:671b-cloud">Cogito-2.1</option>
      <option value="qwen3-next:80b-cloud">Qwen3-Next</option>
      <option value="rnj-1:8b-cloud">Rnj-1</option>
      <option value="mistral-large-3:675b-cloud">Mistral-Large-3</option>
    </select>

    <div id="thinkingControls" style="margin-bottom: 10px; display: none;">
      <div id="gptThinking" style="display: none;">
        <label>Thinking Level</label>
        <select id="thinkLevel">
          <option value="low">Low</option>
          <option value="medium">Medium</option>
          <option value="high">High</option>
        </select>
      </div>
      <div id="otherThinking" style="display: none;">
        <label style="display:inline-flex; align-items: center; font-weight: normal;">
          <input type="checkbox" id="thinkingMode" style="width: auto; margin-right: 5px; margin-bottom: 0;"> Enable Thinking Mode
        </label>
      </div>
    </div>

    <div style="display: flex; gap: 5px;">
      <button id="testConnection" class="secondary" style="flex: 1;"><i class="bi bi-wifi"></i> Test Connection</button>
      <button id="saveConfig" class="secondary" style="flex: 1;"><i class="bi bi-floppy"></i> Save Config</button>
    </div>
    <div id="configStatus" style="margin-top: 0; font-size: 0.9em; text-align: center; display: none;"></div>
  </div>

  <div class="card">
    <h3><i class="bi bi-list-check"></i> 1. Define Role / Rubric</h3>
    <div style="margin-bottom: 10px; display: flex; gap: 10px;">
      <label style="display:inline-flex; align-items: center; font-weight: normal;">
        <input type="radio" name="rubricMode" value="text" checked style="width: auto; margin-right: 5px; margin-bottom: 0;"> Text
      </label>
      <label style="display:inline-flex; align-items: center; font-weight: normal;">
        <input type="radio" name="rubricMode" value="table" style="width: auto; margin-right: 5px; margin-bottom: 0;"> Table
      </label>
    </div>

    <div style="display: flex; gap: 5px; margin-bottom: 5px;">
      <button id="btnGetRubricText" class="secondary" style="margin-bottom: 0; font-size: 12px; flex: 1;"><i class="bi bi-text-paragraph"></i> Get Highlighted Text</button>
      <button id="btnImportRubric" class="secondary" style="margin-bottom: 0; font-size: 12px; flex: 1;"><i class="bi bi-stars"></i> Import Rubric from Highlighted Text</button>
    </div>
    
    <div style="display: flex; gap: 5px; margin-bottom: 10px;">
      <button id="btnRubricArea" class="secondary" style="margin-bottom: 0; font-size: 12px; flex: 1;"><i class="bi bi-crop"></i> Screenshot Area</button>
      <button id="btnImportRubricImage" class="secondary" style="margin-bottom: 0; font-size: 12px; flex: 1;"><i class="bi bi-file-image"></i> Import Rubric from Screenshot</button>
    </div>

    <div id="rubricStatus" style="display:none; margin-bottom: 10px; padding: 8px; background: #e0f2fe; border: 1px solid #bae6fd; border-radius: 4px; color: #0369a1; font-size: 12px; align-items: center; gap: 8px;">
      <div class="spinner" style="width: 12px; height: 12px; border: 2px solid #0369a1; border-top-color: transparent; border-radius: 50%; animation: spin 1s linear infinite;"></div>
      <span id="rubricStatusText">Processing...</span>
    </div>

    <div id="rubricTextContainer">
      <div id="rubricText" class="rich-editor" contenteditable="true" placeholder="Paste rubric text here or upload image..."></div>
    </div>

    <div id="rubricTableContainer" style="display:none;">
      <table id="rubricTable" style="width:100%; border-collapse: collapse; margin-bottom: 10px; font-size: 12px;">
        <thead>
          <tr style="background: #f1f1f1;">
            <th style="border: 1px solid #ddd; padding: 5px; text-align: left;">Criteria</th>
            <th style="border: 1px solid #ddd; padding: 5px; text-align: left;">Description</th>
            <th style="border: 1px solid #ddd; padding: 5px; text-align: left; width: 50px;">Pts</th>
            <th style="border: 1px solid #ddd; padding: 5px; width: 20px;"></th>
          </tr>
        </thead>
        <tbody>
          <!-- Rows will be added here -->
        </tbody>
      </table>
      <button id="btnAddRow" class="secondary" style="width: auto; padding: 5px 10px; font-size: 12px;">+ Add Row</button>
    </div>

    <input type="file" id="rubricUpload" accept="image/*" multiple>
    <div id="rubricImagesContainer" style="display: flex; flex-wrap: wrap; gap: 5px; margin-top: 5px;"></div>
  </div>

  <div class="card">
    <h3><i class="bi bi-person-workspace"></i> 2. Student Work</h3>
    <button id="btnHighlight" class="secondary">Get Highlighted Text</button>
    <button id="btnStudentArea" class="secondary" style="margin-bottom: 5px;"><i class="bi bi-crop"></i> Screenshot Area</button>
    
    <div id="studentText" class="rich-editor" contenteditable="true" placeholder="Student text will appear here..."></div>
    <div id="studentImagesContainer" style="display: flex; flex-wrap: wrap; gap: 5px; margin-top: 5px;"></div>
  </div>

  <div class="card">
    <button id="btnGrade">Run Assessment</button>
    <div id="status"></div>
  </div>

  <div class="card">
    <h3><i class="bi bi-clipboard-check"></i> Result:</h3>
    <details id="thinkingContainer" style="display:none; background:#f0f0f0; padding:10px; border-radius:4px; margin-bottom:10px; font-size:12px; color:#555; border-left: 3px solid #999;">
      <summary style="cursor: pointer; font-weight: bold;">Show Thinking Process</summary>
      <div id="thinkingContent" style="white-space: pre-wrap; margin-top:5px;"></div>
    </details>
    <div id="response"></div>
  </div>

  <script src="lib/mathlive.min.js"></script>
  <script src="prompts.js"></script>
  <script src="sidepanel.js"></script>
</body>
</html>